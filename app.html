<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agora / Réseau (prototype) — Charlott’ Street Club</title>
  <meta name="description" content="Charlott’ Street Club — Prototype 100% client-side (aucune collecte)."/>
  <meta property="og:title" content="Agora / Réseau (prototype) — Charlott’ Street Club"/>
  <meta property="og:type" content="website"/>
  <meta property="og:image" content="./assets/logo-hero.png"/>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <nav class="topbar-nav">
      <div class="brand">
        <img src="./assets/logo-hero.png" alt="Logo CSC"/>
        <span>Charlott’ Street Club</span>
      </div>
      <a class="nav" href="./index.html">Accueil</a>
      <a class="nav" href="./app.html">/app</a>
      <a class="nav" href="./segments.html">/segments</a>
      <a class="nav" href="./media-kit.html">/media-kit</a>
      <a class="nav" href="./partenaires.html">/partenaires</a>
      <a class="nav" href="./associations.html">/associations</a>
      <span style="flex:1"></span>
      <a class="nav is-cta" href="./app.html">Rejoindre l’Agora</a>
    </nav>
  </header>

  <!-- Profil local -->
  <div class="csc-profile" id="csc-profile" style="padding:12px 16px;">
    <span class="csc-avatar" data-avatar></span>
    <input name="name" id="csc-profile-name" placeholder="Ton pseudo (local)" aria-label="Ton pseudo"/>
    <button type="button" data-profile-save>Enregistrer</button>
    <span>Bienvenue, <strong data-user-name>Anonyme</strong></span>
  </div>

  <!-- Contenu principal -->
  <main class="container">
    <h2>Agora — Mini-réseau (local)</h2>
    <p class="meta">Tout est stocké dans ton navigateur (localStorage). Pas de serveur, pas de collecte.</p>

    <!-- Composer -->
    <section class="card">
      <form id="composer" style="display:flex;gap:.6rem;align-items:flex-start">
        <textarea id="content" rows="3" style="flex:1;border-radius:12px;padding:10px" placeholder="Écris un message…"></textarea>
        <button class="button primary" type="submit">Publier</button>
      </form>
    </section>

    <!-- Feed -->
    <section id="feed" class="grid" aria-live="polite" style="margin-top:16px"></section>

    <hr/>

    <!-- Outils -->
    <div class="csc-tools" style="display:flex;gap:.5rem;flex-wrap:wrap;">
      <button class="button outline" id="btn-reset">Réinitialiser les données</button>
      <button class="button" id="btn-export">Exporter (.json)</button>
      <label class="button ghost" for="file-import" style="cursor:pointer;">Importer (.json)</label>
      <input type="file" id="file-import" accept="application/json" hidden/>
    </div>

    <p class="meta">Démo — localStorage uniquement (aucune collecte serveur).</p>
  </main>

  <!-- Script unique : profil + feed -->
  <script>
  (function(){
    // --- Clés de stockage ---
    const FEED_KEY = 'csc_feed_v1';
    const PROFILE_KEY = 'csc_profile_v1';

    // --- Sélecteurs ---
    const $userDisplay = document.querySelector('[data-user-name]');
    const $profileInput = document.getElementById('csc-profile-name');
    const $profileSave  = document.querySelector('[data-profile-save]');
    const $composer     = document.getElementById('composer');
    const $content      = document.getElementById('content');
    const $feed         = document.getElementById('feed');

    const $btnReset  = document.getElementById('btn-reset');
    const $btnExport = document.getElementById('btn-export');
    const $fileImport= document.getElementById('file-import');

    // --- Helpers ---
    const safeParse = (j, f) => { try { return JSON.parse(j); } catch { return f; } };

    const readFeed   = () => safeParse(localStorage.getItem(FEED_KEY)   || '[]', []);
    const writeFeed  = (items) => { localStorage.setItem(FEED_KEY, JSON.stringify(items)); renderFeed(); };

    function readProfile(){
      const p = safeParse(localStorage.getItem(PROFILE_KEY) || '{}', {});
      if (p?.name) return p;
      // rétrocompat (au cas où)
      const legacy = safeParse(localStorage.getItem('csc_profile') || '{}', {});
      if (legacy?.name) return legacy;
      return {};
    }
    function writeProfile(p){
      localStorage.setItem(PROFILE_KEY, JSON.stringify(p || {}));
      renderProfile();
    }

    // Récupère le pseudo fiable : champ > stockage > "Anonyme"
    function currentName(){
      const fromInput = ($profileInput?.value || '').trim();
      if (fromInput) return fromInput;
      const stored = (readProfile().name || '').trim();
      return stored || 'Anonyme';
    }

    // Migration : pose un author.name si absent
    function migrateFeedAuthor(){
      const n = (readProfile().name || '').trim();
      if (!n) return;
      const items = readFeed();
      let changed = false;
      for (const p of items){
        const cur = (p.author?.name || p.authorName || '').trim();
        if (!cur || cur === 'Anonyme'){
          p.author = { name: n };
          delete p.authorName; // nettoie anciens champs si présents
          changed = true;
        }
      }
      if (changed) localStorage.setItem(FEED_KEY, JSON.stringify(items));
    }

    // Rendus
    function renderProfile(){
      const n = (readProfile().name || '').trim();
      $userDisplay.textContent = n || 'Anonyme';
      if ($profileInput && document.activeElement !== $profileInput){
        $profileInput.value = n || '';
      }
    }

    function esc(s){
      return String(s||'')
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function renderFeed(){
      const items = readFeed();
      if (!items.length){
        $feed.innerHTML = '<div class="card">Aucun post… commence par écrire ✍️</div>';
        return;
      }
      $feed.innerHTML = items.map((p,i)=>{
        const name = p.author?.name || p.authorName || readProfile().name || 'Anonyme';
        return `
          <article class="card">
            <div class="small meta">
              <strong>${esc(name)}</strong> — ${new Date(p.ts).toLocaleString('fr-FR')}
            </div>
            <p style="white-space:pre-wrap">${esc(p.text)}</p>
            <div style="display:flex;gap:.5rem">
              <button class="button ghost" data-like="${i}" aria-label="Aimer">❤️ ${p.likes||0}</button>
              <button class="button outline" data-del="${i}" aria-label="Supprimer">Supprimer</button>
            </div>
          </article>
        `;
      }).join('');
    }

    // Events like/supprimer (délégation)
    $feed.addEventListener('click', (e)=>{
      const likeIdx = e.target.closest('[data-like]')?.getAttribute('data-like');
      const delIdx  = e.target.closest('[data-del]')?.getAttribute('data-del');

      if (likeIdx !== null && likeIdx !== undefined){
        const idx = Number(likeIdx);
        const items = readFeed();
        if (!items[idx]) return;
        items[idx].likes = (items[idx].likes||0) + 1;
        writeFeed(items);
        return;
      }
      if (delIdx !== null && delIdx !== undefined){
        const idx = Number(delIdx);
        const items = readFeed();
        if (!items[idx]) return;
        items.splice(idx,1);
        writeFeed(items);
        return;
      }
    });

    // Publier (auto-sauvegarde du pseudo si présent)
    $composer.addEventListener('submit', (e)=>{
      e.preventDefault();
      const txt = ($content.value || '').trim();
      if (!txt) return;

      const name = currentName();
      if (name && name !== 'Anonyme'){
        writeProfile({ name }); // auto-save
      }

      const items = readFeed();
      items.unshift({
        text: txt,
        ts: Date.now(),
        likes: 0,
        author: { name }
      });
      writeFeed(items);
      $content.value = '';
    });

    // Sauvegarder le profil (bouton) + Enter
    $profileSave.addEventListener('click', ()=>{
      const n = currentName();
      writeProfile({ name: n });
      migrateFeedAuthor();
      renderFeed();
    });
    $profileInput?.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        const n = currentName();
        writeProfile({ name: n });
        migrateFeedAuthor();
        renderFeed();
      }
    });
    $profileInput?.addEventListener('blur', ()=>{
      const n = ($profileInput.value || '').trim();
      if (n) writeProfile({ name: n });
    });

    // Reset / Export / Import
    document.getElementById('btn-reset').addEventListener('click', ()=>{
      if (confirm('Réinitialiser ton profil et tous les posts locaux ?')){
        localStorage.removeItem(FEED_KEY);
        localStorage.removeItem(PROFILE_KEY);
        renderProfile();
        renderFeed();
      }
    });
    $btnExport.addEventListener('click', ()=>{
      const data = { profile: readProfile(), feed: readFeed(), exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data,null,2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'csc-local-data.json'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
    $fileImport.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      try{
        const text = await f.text();
        const data = JSON.parse(text);
        if (data?.profile) localStorage.setItem(PROFILE_KEY, JSON.stringify(data.profile));
        if (Array.isArray(data?.feed)) localStorage.setItem(FEED_KEY, JSON.stringify(data.feed));
        migrateFeedAuthor();
        renderProfile();
        renderFeed();
        alert('Import OK');
      }catch{ alert('Fichier invalide.'); }
      finally{ e.target.value=''; }
    });

    // Init
    renderProfile();
    migrateFeedAuthor();
    renderFeed();
  })();
  </script>

  <!-- Bouton flottant global -->
  <script defer src="./js/cta.js"></script>
</body>
</html>


